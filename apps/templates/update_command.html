{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>COM ARKEYEZ | Update Order</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #103cbe;">
        <div class="container-fluid">
            <a class="navbar-brand text-white fw-bold" href="#">ARKEYEZ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link text-white" href="{% url 'home' %}">Home</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="{% url 'stock' %}">Stock</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="{% url 'doc' %}">Documents</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="{% url 'partners' %}">Partners</a></li>
                </ul>
                <form class="d-flex" method="GET" action="{% url 'search_command' %}">
                    {% csrf_token %}
                    <input class="form-control me-2" type="search" name="searched" id="searched" placeholder="Search order...">
                    <button class="btn btn-outline-light" type="submit">Search</button>
                </form>
                <a class="btn btn-outline-light ms-2" href="{% url 'logout_view' %}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="row border rounded-5 p-3 bg-white shadow box-area">
            <div class="col-md-6 rounded-4 d-flex justify-content-center align-items-center flex-column left-box" style="background: #103cbe;">
                <div class="featured-image mb-3">
                    <img src="{% static 'images/1.png' %}" class="img-fluid" style="width: 250px;" alt="Your Image">
                </div>
                <p class="text-white fs-2" style="font-family: 'Courier New', Courier, monospace; font-weight: 600;">Go Digital</p>
                <small class="text-white text-wrap text-center" style="width: 17rem; font-family: 'Courier New', Courier, monospace;">Enjoy a better experience with ARKEYEZ Customer Sales Order Management System</small>
            </div>

            <div class="col-md-6 right-box">
                <div class="row align-items-center">
                    <div class="header-text mb-4">
                        <h3>Update Order</h3>
                    </div>
                    <form method="POST" id="commandForm">
                        {% csrf_token %}
                        <label for="customer_id" class="form-label">Select Customer:</label>
                        <select name="customer_id" id="customer_id" class="form-select mb-3" required>
                            <option value="" disabled>Select a customer</option>
                            {% for customer in customers %}
                                <option value="{{ customer.pk }}" {% if command.customer.pk == customer.pk %}selected{% endif %}>
                                    {{ customer.customer_name }}
                                </option>
                            {% endfor %}
                        </select>
                    
                        <label for="order_date" class="form-label">Order Date:</label>
                        <input type="date" id="order_date" name="order_date" class="form-control mb-3" value="{{ command.order_date|date:'Y-m-d' }}" required>
                    
                        <label for="shipping_address" class="form-label">Shipping Address:</label>
                        <input type="text" id="shipping_address" name="shipping_address" class="form-control mb-3" value="{{ command.shipping_address }}" required>
                    
                        <label for="delivery_id" class="form-label">Select Delivery Person:</label>
                        <select name="delivery_id" id="delivery_id" class="form-select mb-3" required>
                            <option value="" disabled>Select a delivery person</option>
                            {% for delivery in deliveries %}
                                <option value="{{ delivery.pk }}" {% if command.delivery.pk == delivery.pk %}selected{% endif %}>
                                    {{ delivery.delivery_person }} - {{ delivery.company_name }}
                                </option>
                            {% endfor %}
                        </select>
                    
                        <div id="variantRows"></div>
                        <input type="hidden" name="variant_combinations">
                        <div class="d-flex justify-content-between">
                            <button type="button" id="addRowButton" class="btn btn-success">Add Row</button>
                            <button type="button" id="removeRowButton" class="btn btn-danger">Remove Last Row</button>
                        </div>
                        <div class="input-group mb-3 d-flex justify-content-center">
                            <button class="btn btn-lg btn-primary w-100 fs-6" style="min-width: 200px;" type="submit">Update Order</button>
                        </div>
                    </form>
                    
                    
                    
                    
                    
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>About Us</h5>
                    <p>ARKEYEZ is a startup offering ERP and CRM solutions to streamline work, making it digital and efficient.</p>
                </div>
                <div class="col-md-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white">About</a></li>
                        <li><a href="#" class="text-white">Privacy Policy</a></li>
                        <li><a href="#" class="text-white">Help</a></li>
                        <li><a href="#" class="text-white">Terms & Conditions</a></li>
                        <li><a href="#" class="text-white">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact Us</h5>
                    <ul class="list-unstyled">
                        <li><i class="fa fa-map-marker me-2"></i>Tunisia, Tataouine Nord, Cyber Park 3200</li>
                        <li><i class="fa fa-phone me-2"></i><a href="tel:20 890 113" class="text-white">20 890 113</a></li>
                        <li><i class="fa fa-envelope me-2"></i><a href="mailto:info@arkeyes.com" class="text-white">info@arkeyes.com</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const variantData = {{ variant_data|safe }};
        const variantRowsContainer = document.getElementById("variantRows");
        const addRowButton = document.getElementById("addRowButton");
        const removeRowButton = document.getElementById("removeRowButton");
        const variantCombinationsInput = document.querySelector('input[name="variant_combinations"]');
    
        let rowCount = 0;
    
        function renderVariantOptions(productId, rowId) {
            const variantGroup = document.getElementById(`variant_group_${rowId}`);
            variantGroup.innerHTML = ""; // Clear existing variants
    
            const variants = variantData[productId];
            if (variants) {
                Object.entries(variants).forEach(([variantName, variantValues]) => {
                    const label = document.createElement("label");
                    label.textContent = `Select ${variantName}:`;
                    label.classList.add("form-label");
    
                    const select = document.createElement("select");
                    select.classList.add("form-select", "mb-2");
                    select.setAttribute("data-variant-name", variantName);
    
                    select.innerHTML = '<option value="" disabled selected>Choose an option</option>';
                    variantValues.forEach(value => {
                        const option = document.createElement("option");
                        option.value = value;
                        option.textContent = value;
                        select.appendChild(option);
                    });
    
                    variantGroup.appendChild(label);
                    variantGroup.appendChild(select);
                });
            } else {
                variantGroup.innerHTML = '<p class="text-muted">No variants available for this product.</p>';
            }
        }
    
        function updateVariantCombinations() {
            const combinations = [];
            const rows = document.querySelectorAll(".variant-row");
            rows.forEach(row => {
                const rowId = row.id.split("_")[1];
                const productId = row.querySelector(".product-select").value;
                const quantity = row.querySelector("input[type='number']").value;
                const variants = {};
    
                row.querySelectorAll(".variant-group select").forEach(select => {
                    const variantName = select.getAttribute("data-variant-name");
                    const variantValue = select.value;
                    if (variantName && variantValue) {
                        variants[variantName] = variantValue;
                    }
                });
    
                if (productId && quantity) {
                    combinations.push({
                        product: productId,
                        quantity: parseInt(quantity),
                        variant_combination: variants,
                    });
                }
            });
    
            console.log("Updated combinations:", combinations); // Debugging
            variantCombinationsInput.value = JSON.stringify(combinations);
        }
    
        function addRow() {
            const rowId = rowCount++;
            const row = document.createElement("div");
            row.classList.add("variant-row", "mb-3");
            row.id = `row_${rowId}`;
    
            row.innerHTML = `
                <label for="product_${rowId}" class="form-label">Select Product:</label>
                <select id="product_${rowId}" class="form-select product-select mb-3" name="product_${rowId}" required>
                    <option value="" disabled selected>Select a product</option>
                    {% for product in products %}
                        <option value="{{ product.pk }}">{{ product.product_name }}</option>
                    {% endfor %}
                </select>
                <div id="variant_group_${rowId}" class="variant-group mb-3"></div>
                <label for="quantity_${rowId}" class="form-label">Quantity:</label>
                <input type="number" id="quantity_${rowId}" class="form-control mb-3" name="quantity_${rowId}" min="1" required>
                <button type="button" class="btn btn-danger btn-sm remove-row-btn" data-row-id="${rowId}">Remove</button>
            `;
    
            variantRowsContainer.appendChild(row);
    
            const productSelect = document.getElementById(`product_${rowId}`);
            productSelect.addEventListener("change", function () {
                renderVariantOptions(this.value, rowId);
            });
    
            row.querySelector(".remove-row-btn").addEventListener("click", function () {
                document.getElementById(`row_${this.getAttribute("data-row-id")}`).remove();
                updateVariantCombinations();
            });
        }
    
        addRowButton.addEventListener("click", addRow);
    
        removeRowButton.addEventListener("click", function () {
            const lastRow = variantRowsContainer.lastElementChild;
            if (lastRow) {
                lastRow.remove();
                updateVariantCombinations();
            }
        });
    
        variantRowsContainer.addEventListener("change", updateVariantCombinations);
    
        addRow();
    });
    
       
</script>
    
    
</body>
</html>
