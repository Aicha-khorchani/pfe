{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>COM ARKEYEZ | Delivery Note</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #103cbe;">
        <div class="container-fluid">
            <a class="navbar-brand text-white fw-bold" href="#">ARKEYEZ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{% url 'home' %}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{% url 'stock' %}">Stock</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{% url 'doc' %}">Documents</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{% url 'partners' %}">Partners</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{% url 'logout_view' %}">Logout</a>
            </li>
        </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container py-5">
        <form method="POST">
            {% csrf_token %}
            {{ formset.management_form }}

            <div class="row justify-content-center">
                <!-- Box 1 -->
                <div class="col-md-12 mb-4">
                    <div class="border rounded-5 p-4 bg-white shadow box-shadow" style="width: 95%; margin: 0 auto;">
                        <h4 class="border-bottom pb-2 mb-4 text-primary">Reception Note Details</h4>
                        <div class="mb-3">
                            <label for="delivery_address" class="form-label">Reception Address</label>
                            <input type="text" id="delivery_address" name="delivery_address" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="delivery_date" class="form-label">Reception Date</label>
                            <input type="date" id="delivery_date" name="delivery_date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplier" class="form-label">Select Supplier</label>
                            <select name="supplier" id="supplier" class="form-select" required>
                                <option value="" disabled selected>Choose a supplier</option>
                                {% for supplier in suppliers %}
                                    <option value="{{ supplier.pk }}">{{ supplier.supplier_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
    
                <!-- Box 2 -->
                <div class="col-md-12 mb-4">
                    <div class="border rounded-5 p-4 bg-white shadow box-shadow" style="width: 95%; margin: 0 auto;">
                        <h4 class="border-bottom pb-2 mb-4 text-primary">Product and Variant Combinations</h4>
                        <table class="table table-bordered align-middle" style="width: 100%; table-layout: fixed;">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 18%;">Product</th>
                                    <th style="width: 16%;">Variant</th>
                                    <th style="width: 16%;">Value</th>
                                    <th style="width: 16%;">Variant</th>
                                    <th style="width: 16%;">Value</th>
                                    <th style="width: 10%;">Quantity</th>
                                    <th style="width: 8%;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="variant-combinations">
                                <tr>
                                    <td>
                                        <select name="lines-0-item" class="form-select item-select" required>
                                            <option value="" disabled selected>Choose a product</option>
                                            {% for item in items %}
                                                <option value="{{ item.item }}">{{ item.product_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <select name="lines-0-variant_1" class="form-select variant-select">
                                            <option value="" disabled selected>Choose a variant</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select name="lines-0-variant_value_1" class="form-select value-select">
                                            <option value="" disabled selected>Choose a value</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select name="lines-0-variant_2" class="form-select variant-select">
                                            <option value="" disabled selected>Choose a variant</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select name="lines-0-variant_value_2" class="form-select value-select">
                                            <option value="" disabled selected>Choose a value</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="lines-0-quantity" class="form-control" min="1" required>
                                    </td>
                                    <td>
                                        <input type="hidden" name="lines-0-variant_combination"> <!-- Hidden field for combination -->
                                        <button type="button" class="btn btn-danger remove-row">Remove</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        
                        <div class="mt-3 text-center">
                            <button type="button" class="btn btn-success" id="add-row" data-bs-toggle="tooltip" data-bs-placement="top" title="Add another combination to the table.">
                                Add Another Combination
                            </button>
                             </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-md-10 d-flex justify-content-center gap-3 mt-4">
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        Add Reception Note
                            <span id="loading-spinner" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                    <button type="submit" class="btn btn-secondary" onclick="window.print()">Print Reception Note</button>
                    <a href="{% url 'all_bonreception' %}" class="btn btn-outline-primary">Show Reception Notes</a>
                </div>
            </div>
        </form>

    </div>
    
    
   
    

    

    <!-- Footer -->
    <footer class="mt-5 bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>About Us</h5>
                    <p>ARKEYEZ is a startup offering ERP and CRM solutions to streamline work, making it digital and efficient.</p>
                    <div>
                        <a href="#" class="text-white me-3"><i class="fa-brands fa-linkedin"></i></a>
                        <a href="#" class="text-white me-3"><i class="fa-brands fa-twitter"></i></a>
                        <a href="#" class="text-white me-3"><i class="fa-brands fa-youtube"></i></a>
                        <a href="#" class="text-white"><i class="fa-solid fa-envelope"></i></a>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white">About</a></li>
                        <li><a href="#" class="text-white">Privacy Policy</a></li>
                        <li><a href="#" class="text-white">Help</a></li>
                        <li><a href="#" class="text-white">Terms & Conditions</a></li>
                        <li><a href="#" class="text-white">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact Us</h5>
                    <ul class="list-unstyled">
                        <li><i class="fa fa-map-marker me-2"></i>Tunisia, Tataouine Nord, Cyber Park 3200</li>
                        <li><i class="fa fa-phone me-2"></i><a href="tel:20 890 113" class="text-white">20 890 113</a></li>
                        <li><i class="fa fa-envelope me-2"></i><a href="mailto:info@arkeyes.com" class="text-white">info@arkeyes.com</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <div class="text-center text-white bg-dark py-2">
        <p>&copy; 2024 Aicha Khorchani. All rights reserved.</p>
    </div>










    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM fully loaded and script initialized.');
        
            const variantData = {{ variant_data|safe }};
            const tableBody = document.getElementById('variant-combinations');
            const addRowButton = document.getElementById('add-row');
        
            // Listener for form submission
            document.querySelector('form').addEventListener('submit', function (e) {
                console.log('Preparing to submit...');
                const rows = document.querySelectorAll('#variant-combinations tr');
        
                rows.forEach((row, index) => {
                    const item = document.querySelector('.item-select').value;  // Always take the first item-select
                    const variants = {};
        
                    row.querySelectorAll('.variant-select').forEach((variantSelect, idx) => {
                        const variantName = variantSelect.value;
                        const valueSelect = row.querySelector(`.value-select[name="lines-${index}-variant_value_${idx + 1}"]`);
                        if (variantName && valueSelect && valueSelect.value) {
                            variants[variantName] = valueSelect.value;
                        }
                    });
        
                    const variantCombinationInput = row.querySelector(`input[name="lines-${index}-variant_combination"]`);
                    if (variantCombinationInput) {
                        variantCombinationInput.value = JSON.stringify(variants);
                    }
        
                    if (!item || Object.keys(variants).length === 0) {
                        e.preventDefault();
                        console.error(`Row ${index + 1}: Missing required fields.`);
                        alert(`Row ${index + 1}: Please complete all required fields.`);
                    }
                });
            });
        
            // Populate variants and their values dynamically
            tableBody.addEventListener('change', function (event) {
                const row = event.target.closest('tr');
                const productId = row.querySelector('.item-select')?.value;
        
                if (event.target.classList.contains('variant-select')) {
                    // Update value dropdown based on the selected variant
                    const variant = event.target.value;
                    const valueSelect = row.querySelector(`.value-select[name="${event.target.name.replace('variant', 'variant_value')}"]`);
        
                    // Clear existing options
                    valueSelect.innerHTML = '<option value="" disabled selected>Choose a value</option>';
        
                    if (variantData[productId] && variantData[productId][variant]) {
                        variantData[productId][variant].forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            valueSelect.appendChild(option);
                        });
                    } else {
                        console.warn(`No values found for variant "${variant}" in product ID "${productId}"`);
                    }
                }
        
                if (event.target.classList.contains('item-select')) {
                    // Update variants based on selected product
                    const variantSelects = row.querySelectorAll('.variant-select');
                    const valueSelects = row.querySelectorAll('.value-select');
        
                    variantSelects.forEach(select => {
                        select.innerHTML = '<option value="" disabled selected>Choose a variant</option>';
                        if (variantData[productId]) {
                            Object.keys(variantData[productId]).forEach(variant => {
                                const option = document.createElement('option');
                                option.value = variant;
                                option.textContent = variant;
                                select.appendChild(option);
                            });
                        }
                    });
        
                    valueSelects.forEach(select => {
                        select.innerHTML = '<option value="" disabled selected>Choose a value</option>';
                    });
                }
            });
        
            // Add a new row
            addRowButton.addEventListener('click', function () {
                console.log('Adding a new row...');
                const newRow = tableBody.rows[0].cloneNode(true);
        
                newRow.querySelectorAll('input, select').forEach((input) => {
                    input.value = '';
                    const nameAttr = input.getAttribute('name');
                    if (nameAttr) {
                        const updatedName = nameAttr.replace(/\d+/, tableBody.rows.length);
                        input.setAttribute('name', updatedName);
                    }
                });
        
                tableBody.appendChild(newRow);
                updateTotalForms();
            });
        
            // Remove a row
            tableBody.addEventListener('click', function (event) {
                if (event.target.classList.contains('remove-row')) {
                    if (tableBody.rows.length > 1) {
                        event.target.closest('tr').remove();
                        updateTotalForms();
                    }
                }
            });
        
            function updateTotalForms() {
                const totalForms = document.querySelector('input[name="lines-TOTAL_FORMS"]');
                totalForms.value = tableBody.rows.length;
                console.log('Updated TOTAL_FORMS:', totalForms.value);
            }
        
            updateTotalForms();
        });
        </script>
        
        
        
    
        

    
            
    
    
    
</body>
</html>
